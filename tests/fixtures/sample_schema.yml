version: 2

models:
  - name: customer_summary
    description: "Aggregated customer metrics and lifetime value calculations"
    config:
      materialized: table
      schema: marts_core
      tags: ["customer", "daily"]
    columns:
      - name: customer_id
        description: "Unique identifier for each customer"
        data_type: string
        tests:
          - unique
          - not_null
      - name: customer_name
        description: "Full name of the customer"
        data_type: string
      - name: total_orders
        description: "Total number of orders placed by the customer"
        data_type: integer
        tests:
          - not_null
      - name: total_revenue
        description: "Total revenue generated from the customer"
        data_type: numeric
        tests:
          - not_null
      - name: first_order_date
        description: "Date of the customer's first order"
        data_type: date
      - name: last_order_date
        description: "Date of the customer's most recent order"
        data_type: date
      - name: customer_segment
        description: "Customer segmentation based on behavior"
        data_type: string
        tests:
          - accepted_values:
              values: ['high_value', 'medium_value', 'low_value', 'churned']
    tests:
      - dbt_utils.recency:
          datepart: day
          field: last_order_date
          interval: 1

  - name: order_facts
    description: "Order-level metrics and calculations"
    config:
      materialized: incremental
      unique_key: order_id
      on_schema_change: fail
    columns:
      - name: order_id
        description: "Unique order identifier"
        tests:
          - unique
          - not_null
      - name: customer_id
        description: "Reference to customer"
        tests:
          - not_null
          - relationships:
              to: ref('customer_summary')
              field: customer_id
      - name: order_date
        description: "Date when the order was placed"
        data_type: date
      - name: order_status
        description: "Current status of the order"
        tests:
          - accepted_values:
              values: ['pending', 'confirmed', 'shipped', 'delivered', 'cancelled']
      - name: total_amount
        description: "Total order amount including tax"
        data_type: numeric
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

sources:
  - name: raw_data
    database: analytics-prod
    schema: raw
    description: "Raw data from production systems"
    freshness:
      warn_after: {count: 12, period: hour}
      error_after: {count: 24, period: hour}
    loaded_at_field: _loaded_at
    tables:
      - name: customers
        description: "Raw customer data from CRM"
        columns:
          - name: id
            description: "Customer ID from source system"
            tests:
              - unique
              - not_null
      - name: orders
        description: "Raw order data from order management system"
        columns:
          - name: id
            description: "Order ID from source system"
          - name: customer_id
            description: "Customer reference"

exposures:
  - name: customer_dashboard
    type: dashboard
    maturity: high
    owner:
      name: Analytics Team
      email: analytics@company.com
    description: "Executive dashboard for customer metrics"
    depends_on:
      - ref('customer_summary')
      - ref('order_facts')
    url: https://app.company.com/dashboards/customers

metrics:
  - name: revenue_growth
    label: "Revenue Growth Rate"
    model: ref('order_facts')
    description: "Month-over-month revenue growth percentage"
    calculation_method: derived
    expression: "(current_month_revenue - previous_month_revenue) / previous_month_revenue * 100"
    timestamp: order_date
    time_grains: [day, week, month, quarter, year]
    dimensions:
      - customer_segment
      - order_status
    filters:
      - field: order_status
        operator: '!='
        value: 'cancelled'